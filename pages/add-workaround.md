---
title: 個別税率設定が適用されない不具合について
tags: [spec, getting_started]
permalink: add-workaround
summary: EC-CUBEでは、税率の設定について、基本税率と商品ごとの商品別税率を設定することができます。
---

## 個別税率設定が適用されない不具合について

増税に伴い、基本税率設定に10%の設定追加や、軽減税率対応のため個別税率設定を適用する際、特定の時系列で設定を行なった場合に、商品購入時の税率に個別税率設定が適用されない不具合が発生しています。

以下の「対象となるケース」から、不具合の発生する設定を行なっていないかご確認いただき、対象となる場合は「不具合の解消」にある手順を適用していただくようお願い申し上げます。

## 不具合の内容と対策

#### 不具合の内容

EC-CUBEの本体バージョンが４系または３系で、基本税率設定を設定する際の「適用日時」より前に、商品の個別税率設定を設定すると、商品の購入時に基本税率設定の税率が適用されます。

#### 不具合の対策

商品の購入時、「dtb_tax_rule」テーブルの、「apply_date（適用日時）」を元にその商品に適用される税率を取得します。

商品ごとの個別税率の設定は、設定を行った日時で「apply_date（適用日時）」を登録するため、基本税率設定でより最新の「apply_date（適用日時）」が設定されている場合は、基本税率設定の税率が優先されます。

個別税率の税率設定の「apply_date（適用日時）」が、基本税率設定で設定されている、「apply_date（適用日時）」より最新の状態に設定すれば不具合が解消することを確認しています。

不具合の詳細に関しては、[こちら](https://github.com/EC-CUBE/ec-cube/issues/4330)からご確認ください。

## 対象となるケース

今回の個別税率設定が適用されない不具合に関しては、以下の全てに該当している場合に、問題が発生することを確認しています。

- EC-CUBEの本体バージョンが４系または３系のバージョンである
- 基本税率設定で10%の税率を設定されている
- 基本税率設定で設定した10%の税率の「適用日時」より前に商品の個別税率を設定されている

今回の不具合の対象となるケースは、以下の図のように基本税率設定で10%の税率の「適用日時」を ”2019年10月1日 00:00:00” に設定されている状態で、個別税率の設定を、”2019年10月1日 00:00:00” より前の日時に設定されている場合に発生します。

![](/images/tax_setting_time_series.png)

## 不具合の解消

#### 基本税率の設定を個別税率適用前の日時に設定する方法

- 管理画面の「店舗設定/税率設定」の画面を表示し、追加した税率設定の適用日時を変更します。



#### 商品情報を基本税率の適用日時以降に更新する方法

基本税率設定で10%の税率の「適用日時」を ”2019年10月1日 00:00:00” に設定されている場合は「適用日時」以降に、以下の手順のように２回登録を行い、更新していただくと不具合を解消することができます。

- 「管理画面/商品管理」から、個別税率を適用する商品の編集画面を表示します。
- 個別税率の入力フォームを、未入力の状態に変更し「登録」（１回目）します。
- そのまま、個別税率を適用する商品の編集画面の個別税率の入力フォームを、軽減税率の値で「登録」（２回目）します。


#### SQLでデータベースを更新する方法

以下の値の例は、基本税率設定に10%の税率で「適用日時」が、”2019年10月1日 00:00:00” で設定されていることを前提としています。
SQLで更新をする場合は、更新する値や条件をご確認の上設定をお願いいたします。

###### ・任意のIDに対して更新する場合

`UPDATE dtb_tax_rule SET apply_date = '2019-10-01 00:00:01' WHERE id = [任意のid];`

###### ・「products_class_id」がNULLでないレコードを更新する場合

`UPDATE dtb_tax_rule SET apply_date = '2019-10-01 00:00:01' WHERE products_class_id IS NOT NULL;`

*※ EC-CUBEのデフォルトの仕様では、基本税率設定で登録されたレコードは、「products_class_id」がNULLで登録されます。*
